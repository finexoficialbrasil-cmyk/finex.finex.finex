import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import { jsPDF } from 'npm:jspdf@2.5.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user) {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        let y = 20;
        const lineHeight = 7;
        const pageHeight = 280;
        const margin = 20;

        const addText = (text, fontSize = 10, isBold = false, color = [0, 0, 0]) => {
            if (y > pageHeight) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(fontSize);
            doc.setTextColor(color[0], color[1], color[2]);
            doc.setFont(undefined, isBold ? 'bold' : 'normal');
            
            const lines = doc.splitTextToSize(text, 170);
            lines.forEach(line => {
                if (y > pageHeight) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(line, margin, y);
                y += lineHeight;
            });
        };

        const addCheckbox = (text) => {
            if (y > pageHeight) {
                doc.addPage();
                y = 20;
            }
            
            doc.setDrawColor(100, 100, 100);
            doc.rect(margin, y - 4, 4, 4);
            doc.setFontSize(9);
            doc.setTextColor(50, 50, 50);
            
            const lines = doc.splitTextToSize(text, 160);
            lines.forEach((line, index) => {
                if (y > pageHeight) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(line, margin + 7, y);
                y += index < lines.length - 1 ? 5 : 6;
            });
        };

        const addSection = (title, color = [138, 43, 226]) => {
            y += 3;
            if (y > pageHeight - 10) {
                doc.addPage();
                y = 20;
            }
            doc.setFillColor(color[0], color[1], color[2]);
            doc.rect(margin, y - 5, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(title, margin + 2, y);
            y += 10;
        };

        // Header
        doc.setFillColor(138, 43, 226);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('FINEX', 105, 20, { align: 'center' });
        doc.setFontSize(10);
        doc.text('CHECKLIST COMPLETO DO SISTEMA', 105, 28, { align: 'center' });
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 105, 35, { align: 'center' });

        y = 50;

        // 1. DESIGN E INTERFACE
        addSection('1. DESIGN E INTERFACE', [138, 43, 226]);
        addText('Layout e Navega√ß√£o', 11, true);
        addCheckbox('Sidebar responsiva com menu lateral');
        addCheckbox('Logo e nome do app personaliz√°veis (FINEX)');
        addCheckbox('Tema escuro por padr√£o (Dark, Light, Purple, Blue, Green)');
        addCheckbox('Efeitos visuais personaliz√°veis');
        addCheckbox('Design responsivo (mobile/tablet/desktop)');
        addCheckbox('√çcones Lucide React integrados');
        addCheckbox('Componentes shadcn/ui');
        addCheckbox('Gradientes glamurosos em cards e bot√µes');
        y += 2;

        addText('Comprovantes', 11, true);
        addCheckbox('Comprovante de Pagamento com design glamuroso');
        addCheckbox('Comprovante de Recebimento com design glamuroso');
        addCheckbox('Header com nome FINEX');
        addCheckbox('Cores suaves e elegantes');
        addCheckbox('Bot√£o de impress√£o otimizado');
        addCheckbox('Bot√£o de compartilhamento');
        addCheckbox('Estilos espec√≠ficos para impress√£o');

        // 2. AUTENTICA√á√ÉO E USU√ÅRIOS
        addSection('2. AUTENTICA√á√ÉO E USU√ÅRIOS', [46, 125, 50]);
        addText('Sistema de Login', 11, true);
        addCheckbox('Login autom√°tico via Base44');
        addCheckbox('Logout com redirecionamento');
        addCheckbox('Perfil de usu√°rio edit√°vel');
        addCheckbox('Avatar/foto do perfil');
        addCheckbox('Telefone e prefer√™ncias de tema');
        y += 2;

        addText('Entidade User', 11, true);
        addCheckbox('Campos built-in: id, email, full_name, role');
        addCheckbox('Campos customizados: avatar_url, phone, theme');
        addCheckbox('Configura√ß√µes de tema personaliz√°veis');
        addCheckbox('subscription_status, subscription_plan, subscription_end_date');

        // 3. DASHBOARD
        addSection('3. DASHBOARD', [59, 130, 246]);
        addText('Vis√£o Geral', 11, true);
        addCheckbox('Mensagem de boas-vindas com nome do usu√°rio');
        addCheckbox('Data atual formatada');
        addCheckbox('Bot√£o Nova Transa√ß√£o');
        y += 2;

        addText('Cards de Estat√≠sticas', 11, true);
        addCheckbox('Saldo Total (todas as contas)');
        addCheckbox('Entradas do M√™s (receitas completadas)');
        addCheckbox('Sa√≠das do M√™s (despesas completadas)');
        addCheckbox('Economia (diferen√ßa receitas - despesas)');
        addCheckbox('√çcones e gradientes personalizados');
        y += 2;

        addText('Notifica√ß√µes no Dashboard', 11, true);
        addCheckbox('Notifica√ß√µes de Sistema configur√°veis');
        addCheckbox('Contas a Receber vencendo (pr√≥ximos 7 dias)');
        addCheckbox('Alertas de contas vencidas');
        addCheckbox('Alertas de metas sem progresso');
        y += 2;

        addText('Componentes do Dashboard', 11, true);
        addCheckbox('Se√ß√£o Minhas Contas com saldos');
        addCheckbox('A√ß√µes R√°pidas (Nova Entrada/Sa√≠da/Conta/Meta)');
        addCheckbox('Gr√°fico de Fluxo de Caixa (6 meses)');
        addCheckbox('Progresso de Metas (top 3 ativas)');
        addCheckbox('Transa√ß√µes Recentes (5 mais recentes)');

        // 4. TRANSA√á√ïES
        addSection('4. TRANSA√á√ïES', [236, 72, 153]);
        addText('Funcionalidades', 11, true);
        addCheckbox('Criar Transa√ß√£o com formul√°rio completo');
        addCheckbox('Listar Transa√ß√µes com filtros e ordena√ß√£o');
        addCheckbox('Editar Transa√ß√£o');
        addCheckbox('Excluir Transa√ß√£o');
        addCheckbox('Atualiza√ß√£o autom√°tica de saldo nas contas');
        addCheckbox('Filtros: tipo, categoria, conta, status, per√≠odo');
        addCheckbox('Ordena√ß√£o customiz√°vel');

        // 5. CONTAS E CARTEIRAS
        addSection('5. CONTAS E CARTEIRAS', [168, 85, 247]);
        addText('Tipos de Conta', 11, true);
        addCheckbox('Conta Corrente');
        addCheckbox('Poupan√ßa');
        addCheckbox('Cart√£o de Cr√©dito');
        addCheckbox('Investimentos');
        addCheckbox('Criptomoedas');
        y += 2;

        addText('Funcionalidades', 11, true);
        addCheckbox('Criar Conta com saldo inicial');
        addCheckbox('Listar Contas em grid responsivo');
        addCheckbox('Editar Conta');
        addCheckbox('Transfer√™ncias entre Contas');
        addCheckbox('Cor e √≠cone personalizados');

        // 6. CATEGORIAS
        addSection('6. CATEGORIAS', [245, 158, 11]);
        addText('Categorias do Sistema', 11, true);
        addCheckbox('Sal√°rio, Freelance, Investimentos');
        addCheckbox('Alimenta√ß√£o, Transporte, Moradia');
        addCheckbox('Sa√∫de, Educa√ß√£o, Lazer');
        addCheckbox('N√£o edit√°veis por usu√°rios comuns');
        y += 2;

        addText('Categorias Personalizadas', 11, true);
        addCheckbox('Criar Categoria com nome, tipo, cor, √≠cone');
        addCheckbox('Limite de or√ßamento opcional');
        addCheckbox('Editar apenas categorias do usu√°rio');
        addCheckbox('Excluir com valida√ß√£o');

        // 7. METAS FINANCEIRAS
        addSection('7. METAS FINANCEIRAS', [16, 185, 129]);
        addCheckbox('Criar Meta com t√≠tulo, valor alvo, prazo');
        addCheckbox('Progress bar animado');
        addCheckbox('Adicionar valor √† meta');
        addCheckbox('Notifica√ß√£o ao atingir 100%');
        addCheckbox('Visualiza√ß√£o no Dashboard (top 3)');
        addCheckbox('Status: ativa/completa/pausada');

        // 8. CONTAS A PAGAR
        addSection('8. CONTAS A PAGAR', [239, 68, 68]);
        addCheckbox('Criar Conta a Pagar com fornecedor');
        addCheckbox('Listar com filtros por status, per√≠odo');
        addCheckbox('Pagar Conta gerando transa√ß√£o autom√°tica');
        addCheckbox('Comprovante de Pagamento glamuroso');
        addCheckbox('Notifica√ß√µes de vencimento');
        addCheckbox('Recorr√™ncia opcional');
        addCheckbox('Cores por urg√™ncia (hoje/amanh√£/dias)');

        // 9. CONTAS A RECEBER
        addSection('9. CONTAS A RECEBER', [34, 197, 94]);
        addCheckbox('Criar Conta a Receber com cliente');
        addCheckbox('Listar com filtros por status, per√≠odo');
        addCheckbox('Receber Conta gerando transa√ß√£o autom√°tica');
        addCheckbox('Comprovante de Recebimento glamuroso');
        addCheckbox('Notifica√ß√£o especial no Dashboard');
        addCheckbox('Bot√£o Ver leva para p√°gina Receivables');
        addCheckbox('Recorr√™ncia opcional');

        // 10. RELAT√ìRIOS E EXTRATOS
        addSection('10. RELAT√ìRIOS E EXTRATOS', [236, 72, 153]);
        addText('Relat√≥rios IA', 11, true);
        addCheckbox('An√°lise Mensal Completa');
        addCheckbox('Gr√°fico Pizza por categorias');
        addCheckbox('Gr√°fico de Fluxo de Caixa');
        addCheckbox('Insights gerados por IA');
        addCheckbox('Tend√™ncias e previs√µes');
        y += 2;

        addText('Extrato Financeiro', 11, true);
        addCheckbox('Filtros avan√ßados por per√≠odo');
        addCheckbox('Lista cronol√≥gica com totalizadores');
        addCheckbox('Exporta√ß√£o PDF, Excel/CSV');
        addCheckbox('Impress√£o otimizada');

        // 11. SISTEMA DE ASSINATURAS
        addSection('11. SISTEMA DE ASSINATURAS', [234, 179, 8]);
        addText('Planos Dispon√≠veis', 11, true);
        addCheckbox('Mensal (R$ 19,90)');
        addCheckbox('Semestral (R$ 89,90 - 25% desconto)');
        addCheckbox('Anual (R$ 149,90 - 37% desconto)');
        addCheckbox('Vital√≠cio (R$ 297,00 - acesso permanente)');
        y += 2;

        addText('Integra√ß√£o Asaas', 11, true);
        addCheckbox('Gerar pagamento PIX com QR Code');
        addCheckbox('Webhook de confirma√ß√£o autom√°tica');
        addCheckbox('Ativar assinatura automaticamente');
        addCheckbox('Enviar email de confirma√ß√£o');
        addCheckbox('Registrar logs de transa√ß√µes');
        y += 2;

        addText('SubscriptionGuard', 11, true);
        addCheckbox('Bloquear acesso sem assinatura');
        addCheckbox('Aviso de expira√ß√£o (7 dias antes)');
        addCheckbox('Tela de upgrade glamurosa');
        addCheckbox('Notifica√ß√£o de pagamento aprovado');

        // 12. CONSULTOR IA
        addSection('12. CONSULTOR IA', [251, 191, 36]);
        addCheckbox('Agent com acesso a todas entidades');
        addCheckbox('Criar transa√ß√µes por chat');
        addCheckbox('Consultar saldo e analisar gastos');
        addCheckbox('Sugerir economia');
        addCheckbox('Interface de conversa√ß√£o em tempo real');
        addCheckbox('Hist√≥rico de conversas');
        addCheckbox('Upload de arquivos');
        addCheckbox('Streaming de respostas');
        addCheckbox('WhatsApp (opcional)');

        // 13. ASSISTENTE DE VOZ
        addSection('13. ASSISTENTE DE VOZ', [168, 85, 247]);
        addCheckbox('Reconhecimento de voz em portugu√™s');
        addCheckbox('Bot√£o flutuante (canto inferior direito)');
        addCheckbox('Transcri√ß√£o em tempo real');
        addCheckbox('Detec√ß√£o autom√°tica de tipo, valor, descri√ß√£o');
        addCheckbox('Criar transa√ß√£o por voz');
        addCheckbox('Criar conta a pagar/receber por voz');
        addCheckbox('Feedback visual com modal');
        addCheckbox('Atualiza Dashboard automaticamente');

        // 14. PAINEL ADMINISTRATIVO
        addSection('14. PAINEL ADMINISTRATIVO', [220, 38, 38]);
        addCheckbox('Acesso exclusivo para role: admin');
        addCheckbox('Dashboard Admin com estat√≠sticas');
        addCheckbox('Gerenciamento de Usu√°rios');
        addCheckbox('Gerenciamento de Assinaturas');
        addCheckbox('Gerenciamento de Planos');
        addCheckbox('Categorias do Sistema');
        addCheckbox('Tutoriais do Sistema');
        addCheckbox('Notifica√ß√µes Globais');
        addCheckbox('Configura√ß√µes do Sistema (Branding)');
        addCheckbox('Logs de Webhook');
        addCheckbox('Backup do Sistema');
        addCheckbox('Limpeza de Banco de Dados');

        // 15. APLICATIVO MOBILE
        addSection('15. APLICATIVO MOBILE', [6, 182, 212]);
        addCheckbox('P√°gina Baixar App com informa√ß√µes');
        addCheckbox('Links para iOS (App Store)');
        addCheckbox('Links para Android (Google Play)');
        addCheckbox('QR Codes para download');
        addCheckbox('Configur√°vel pelo admin');

        // 16. TUTORIAIS
        addSection('16. TUTORIAIS', [139, 92, 246]);
        addCheckbox('Grid de v√≠deos');
        addCheckbox('Filtro por categoria');
        addCheckbox('Player de v√≠deo integrado');
        addCheckbox('Contador de visualiza√ß√µes');
        addCheckbox('Categorias: Finan√ßas, Investimentos, Configura√ß√µes, etc');

        // 17. E-MAILS E NOTIFICA√á√ïES
        addSection('17. E-MAILS E NOTIFICA√á√ïES', [236, 72, 153]);
        addCheckbox('E-mail de boas-vindas autom√°tico');
        addCheckbox('E-mail de pagamento aprovado');
        addCheckbox('Notifica√ß√µes in-app');
        addCheckbox('Alertas de vencimento');
        addCheckbox('Notifica√ß√£o de metas atingidas');

        // 18. SEGURAN√áA E PERMISS√ïES
        addSection('18. SEGURAN√áA E PERMISS√ïES', [220, 38, 38]);
        addCheckbox('RLS (Row Level Security) em todas entidades');
        addCheckbox('Permiss√µes de Admin');
        addCheckbox('Service Role para webhooks');
        addCheckbox('Valida√ß√£o de tokens');

        // 19. INTEGRA√á√ïES
        addSection('19. INTEGRA√á√ïES', [16, 185, 129]);
        addText('Asaas (Pagamentos)', 11, true);
        addCheckbox('Criar cobran√ßa PIX');
        addCheckbox('Gerar QR Code');
        addCheckbox('Webhook de confirma√ß√£o');
        y += 2;

        addText('Core Integrations (Base44)', 11, true);
        addCheckbox('InvokeLLM (IA)');
        addCheckbox('SendEmail');
        addCheckbox('UploadFile');
        addCheckbox('GenerateImage');
        addCheckbox('ExtractDataFromUploadedFile');

        // 20. FUNCIONALIDADES ESPECIAIS
        addSection('20. FUNCIONALIDADES ESPECIAIS', [236, 72, 153]);
        addCheckbox('Suporte WhatsApp com bot√£o flutuante');
        addCheckbox('Modo de impress√£o otimizado');
        addCheckbox('Compartilhamento via Web Share API');
        addCheckbox('Design responsivo mobile-first');
        addCheckbox('Breakpoints: sm, md, lg, xl');

        // 21. PERFORMANCE E UX
        addSection('21. PERFORMANCE E UX', [59, 130, 246]);
        addCheckbox('Loading states em todas chamadas');
        addCheckbox('Skeleton loaders');
        addCheckbox('Debounce em buscas');
        addCheckbox('Cache de queries (@tanstack/react-query)');
        addCheckbox('Anima√ß√µes Framer Motion');
        addCheckbox('Transi√ß√µes suaves');
        addCheckbox('Tratamento de erros amig√°vel');

        // 22. ENTIDADES COMPLETAS
        addSection('22. ENTIDADES COMPLETAS', [138, 43, 226]);
        addCheckbox('User (sistema + custom)');
        addCheckbox('Transaction');
        addCheckbox('Account');
        addCheckbox('Category (usu√°rio) + SystemCategory (sistema)');
        addCheckbox('Goal');
        addCheckbox('Bill (payables + receivables)');
        addCheckbox('Transfer');
        addCheckbox('Subscription');
        addCheckbox('SystemPlan');
        addCheckbox('SystemTutorial');
        addCheckbox('SystemNotification');
        addCheckbox('SystemSettings');
        addCheckbox('WebhookLog');

        // 23. BACKEND FUNCTIONS
        addSection('23. BACKEND FUNCTIONS', [245, 158, 11]);
        addCheckbox('asaasCreatePayment (cria cobran√ßa PIX)');
        addCheckbox('asaasWebhook (processa confirma√ß√µes)');
        addCheckbox('generateChecklistPDF (este documento!)');

        // Footer
        doc.addPage();
        y = 100;
        doc.setFillColor(138, 43, 226);
        doc.rect(0, y - 10, 210, 60, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('SISTEMA FINEX COMPLETO', 105, y + 10, { align: 'center' });
        doc.setFontSize(12);
        doc.text('Intelig√™ncia Financeira', 105, y + 20, { align: 'center' });
        doc.setFontSize(10);
        doc.text('‚úÖ Todos os m√≥dulos implementados e testados', 105, y + 30, { align: 'center' });
        doc.text('üöÄ Pronto para produ√ß√£o', 105, y + 38, { align: 'center' });

        const pdfBytes = doc.output('arraybuffer');

        return new Response(pdfBytes, {
            status: 200,
            headers: {
                'Content-Type': 'application/pdf',
                'Content-Disposition': `attachment; filename="FINEX_Checklist_${new Date().toISOString().split('T')[0]}.pdf"`
            }
        });
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        return Response.json({ error: error.message }, { status: 500 });
    }
});